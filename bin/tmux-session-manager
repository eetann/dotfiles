#!/bin/bash

# tmuxセッション一覧をfzfで表示し、アクションを実行
result=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | \
  fzf --prompt="Session: " \
      --preview='tmux list-windows -t {} -F "#{window_index}: #{window_name}"' \
      --preview-window=right:50% \
      --expect=ctrl-q,ctrl-n,ctrl-r \
      --no-select-1 \
      --header='Enter: switch | ^Q: kill | ^N: new | ^R: rename')

# fzfがキャンセルされた場合は終了
if [ -z "$result" ]; then
  exit 0
fi

# 結果を解析（1行目がキー、2行目が選択されたセッション名）
key=$(echo "$result" | sed -n '1p')
session=$(echo "$result" | sed -n '2p')

# アクションに応じて処理
case "$key" in
  ctrl-q)
    # kill: セッション削除
    if [ -n "$session" ]; then
      echo -n "Kill session '$session'? (y/N): "
      read -r answer
      if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        tmux kill-session -t "$session"
        echo "Session '$session' killed."
      else
        echo "Cancelled."
      fi
    fi
    ;;

  ctrl-n)
    # new: 新規セッション作成
    echo -n "New session name: "
    read -r new_session
    if [ -n "$new_session" ]; then
      tmux new-session -d -s "$new_session"
      tmux switch-client -t "$new_session"
      echo "Session '$new_session' created."
    else
      echo "Cancelled."
    fi
    ;;

  ctrl-r)
    # rename: セッション名変更
    if [ -n "$session" ]; then
      echo -n "New name for '$session': "
      read -r new_name
      if [ -n "$new_name" ]; then
        tmux rename-session -t "$session" "$new_name"
        echo "Session renamed to '$new_name'."
      else
        echo "Cancelled."
      fi
    fi
    ;;

  *)
    # switch: セッション切り替え（Enterの場合）
    if [ -n "$session" ]; then
      tmux switch-client -t "$session"
    fi
    ;;
esac
